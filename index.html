<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; connect-src 'self' https://api.kraken.com wss://ws.kraken.com https://api.coingecko.com; img-src 'self' data:;">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="no-referrer">
<title>INCENTIVES - Crypto Trading Game</title>
<link rel="stylesheet" href="styles.css">
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
<script>
// Load theme before render to prevent flash
(function(){
var s=JSON.parse(localStorage.getItem('incentives-settings'))||{};
var t=s.theme||'dark';
document.documentElement.className='theme-'+t;
})();
</script>
</head>
<body>

<div class="container">
  <nav class="top-nav">
    <div class="nav-left">
      <div class="logo">
        <img src="logo.jpg" alt="INCENTIVES" class="logo-img">
        <span class="logo-text">INCENTIVES</span>
      </div>
    </div>
    
    <div class="nav-center">
      <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('trading')">Trading</button>
        <button class="nav-tab" onclick="showTab('challenge')">Challenge</button>
        <button class="nav-tab" onclick="showTab('leaderboard')">Leaderboard</button>
        <button class="nav-tab" onclick="showTab('academy')">Academy</button>
      </div>
    </div>
    
    <div class="nav-right">
      <div id="incentives-balance" class="incentives-bal">
        <span class="incv-icon">üí∞</span>
        <span id="incentives-amount" class="mono">10,000</span>
        <span class="incv-label">INCENTIVES</span>
      </div>
      <div class="wallet-section">
        <button id="connect-wallet" class="connect-btn">Connect Wallet</button>
        <div id="wallet-info" class="wallet-info hidden">
          <span id="wallet-address"></span>
          <button id="disconnect-wallet">√ó</button>
        </div>
      </div>
      <button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
    </div>
  </nav>

  <div id="trading-tab" class="tab-content active">
    <div class="main-grid">
      <div class="chart-panel">
        <div class="chart-header">
          <div class="pair-selector">
            <select id="trading-pair" onchange="changeTradingPair()">
              <option value="ETH/USD">ETH/USD</option>
              <option value="BTC/USD">BTC/USD</option>
              <option value="SOL/USD">SOL/USD</option>
            </select>
          </div>
          <div class="chart-controls">
            <button class="timeframe-btn active" data-timeframe="1m">1m</button>
            <button class="timeframe-btn" data-timeframe="5m">5m</button>
            <button class="timeframe-btn" data-timeframe="15m">15m</button>
            <button class="timeframe-btn" data-timeframe="1h">1h</button>
          </div>
          <div class="price-display">
            <span id="current-price" class="price">$0.00</span>
            <span id="price-change" class="change">+0.00%</span>
          </div>
        </div>
        <div id="tradingview-chart" class="chart-container"></div>
      </div>

      <div class="trading-panel">
        <div class="order-form">
          <div class="balance-display">
            <div class="balance-item">
              <span>USD Balance:</span>
              <span id="usd-balance" class="mono">10000.00</span>
            </div>
            <div class="balance-item">
              <span id="crypto-balance-label">ETH Balance:</span>
              <span id="crypto-balance" class="mono">0.0000</span>
            </div>
          </div>
          <button id="place-order-btn" class="place-order-btn">
            <span>Test Trading</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Settings</h3>
      <button onclick="toggleSettings()" class="close-btn">√ó</button>
    </div>
    <div class="modal-body">
      <p>Settings panel</p>
    </div>
  </div>
</div>

<!-- Notification Container -->
<div id="notification-container"></div>

<!-- FLOATING BUTTONS - WALLET ABOVE RADIO -->
<button id="wallet-float-btn" onclick="toggleWalletPopup()">üëõ</button>
<button id="radio-float-btn" onclick="toggleRadioPopup()">üìª</button>

<!-- Wallet Popup -->
<div id="wallet-popup" class="hidden wallet-popup">
  <div class="wallet-header">
    <h3>üëõ Wallet & Balances</h3>
    <button onclick="toggleWalletPopup()" class="close-wallet">√ó</button>
  </div>
  <div class="wallet-content">
    
    <!-- Token Balances Section -->
    <div class="wallet-section">
      <h4>üíé Token Balances</h4>
      <div class="balance-grid">
        <div class="balance-card incentives-card">
          <div class="balance-icon">üí∞</div>
          <div class="balance-info">
            <div class="balance-label">INCENTIVES</div>
            <div class="balance-amount" id="wallet-incentives">10,000</div>
          </div>
          <button class="balance-action" onclick="openConversionFromWallet()">Convert</button>
        </div>
        
        <div class="balance-card credits-card">
          <div class="balance-icon">üí≥</div>
          <div class="balance-info">
            <div class="balance-label">CREDITS</div>
            <div class="balance-amount" id="wallet-credits">0</div>
          </div>
          <button class="balance-action" onclick="openCreditsManagement()">Manage</button>
        </div>
      </div>
    </div>
    
    <!-- Trading Balances Section -->
    <div class="wallet-section">
      <h4>üìä Trading Balances</h4>
      <div class="balance-grid">
        <div class="balance-card usd-card">
          <div class="balance-icon">üíµ</div>
          <div class="balance-info">
            <div class="balance-label">USD Balance</div>
            <div class="balance-amount" id="wallet-usd">10,000.00</div>
          </div>
          <button class="balance-action" onclick="showTradingTab()">Trade</button>
        </div>
        
        <div class="balance-card crypto-card">
          <div class="balance-icon">‚ü†</div>
          <div class="balance-info">
            <div class="balance-label" id="wallet-crypto-label">ETH Balance</div>
            <div class="balance-amount" id="wallet-crypto">0.0000</div>
          </div>
          <button class="balance-action" onclick="showTradingTab()">Trade</button>
        </div>
      </div>
    </div>
    
    <!-- Quick Actions Section -->
    <div class="wallet-section">
      <h4>‚ö° Quick Actions</h4>
      <div class="quick-actions">
        <button class="quick-action-btn" onclick="openConversionFromWallet()">
          <span class="action-icon">üîÑ</span>
          <span>Convert INCENTIVES</span>
        </button>
        <button class="quick-action-btn" onclick="connectWalletFromPopup()">
          <span class="action-icon">üîó</span>
          <span>Connect Wallet</span>
        </button>
        <button class="quick-action-btn" onclick="showTransactionHistory()">
          <span class="action-icon">üìú</span>
          <span>Transaction History</span>
        </button>
        <button class="quick-action-btn" onclick="showServicePrices()">
          <span class="action-icon">üí∞</span>
          <span>Service Prices</span>
        </button>
      </div>
    </div>
    
    <!-- Portfolio Summary -->
    <div class="wallet-section">
      <h4>üìà Portfolio Summary</h4>
      <div class="portfolio-summary">
        <div class="portfolio-stat">
          <span class="stat-label">Total Portfolio Value:</span>
          <span class="stat-value" id="total-portfolio">$10,000.00</span>
        </div>
        <div class="portfolio-stat">
          <span class="stat-label">Today's P&L:</span>
          <span class="stat-value pnl-positive" id="daily-pnl">+$0.00</span>
        </div>
        <div class="portfolio-stat">
          <span class="stat-label">Active Positions:</span>
          <span class="stat-value" id="active-positions">0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Radio Popup -->
<div id="radio-popup" class="hidden">
  <div class="radio-header">
    <h3>üìª Trading Radio</h3>
    <button onclick="toggleRadioPopup()" class="close-radio">√ó</button>
  </div>
  <div class="radio-content">
    <div class="station-list">
      <div class="station" onclick="playStation('chill')">
        <span class="station-name">Chill Beats</span>
        <span class="station-genre">Lo-fi Hip Hop</span>
      </div>
      <div class="station" onclick="playStation('focus')">
        <span class="station-name">Focus Flow</span>
        <span class="station-genre">Ambient</span>
      </div>
    </div>
  </div>
</div>

<!-- Hidden elements for wallet popup to read from -->
<div style="display: none;">
  <span id="credits-amount">0</span>
</div>

<!-- WALLET POPUP STYLES -->
<style>
/* FLOATING BUTTONS - STACKED VERTICALLY */
#wallet-float-btn {
  position: fixed;
  bottom: 80px; /* Above radio button */
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, #FFD700, #FFA500);
  border: 2px solid #333;
  color: #000;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,.5);
  z-index: 9998;
  transition: all .2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

#wallet-float-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255,215,0,0.4);
  background: linear-gradient(135deg, #FFED4A, #FF8F00);
}

#wallet-float-btn.wallet-active {
  background: linear-gradient(135deg, #00ff41, #00c853);
  color: #000;
}

#radio-float-btn {
  position: fixed;
  bottom: 20px; /* Bottom position */
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
  border: 2px solid #333;
  color: #00ff41;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,.5);
  z-index: 9999;
  transition: all .2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

#radio-float-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,255,65,0.3);
}

#radio-float-btn.radio-active {
  background: linear-gradient(135deg, #00ff41, #00c853);
  color: #000;
}

/* WALLET POPUP STYLES */
.wallet-popup {
  position: fixed;
  top: 70px;
  right: 20px;
  width: 380px;
  max-height: 600px;
  background: var(--bg2, #1a1a1a);
  border: 1px solid var(--border, #333);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  z-index: 10001;
  overflow-y: auto;
  animation: slideInRight 0.2s ease;
}

@keyframes slideInRight {
  from { transform: translateX(20px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.wallet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border, #333);
  background: linear-gradient(135deg, #FFD700, #FFA500);
  border-radius: 12px 12px 0 0;
}

.wallet-header h3 {
  margin: 0;
  color: #000;
  font-size: 16px;
  font-weight: 700;
}

.close-wallet {
  background: none;
  border: none;
  color: #000;
  font-size: 20px;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all .2s;
}

.close-wallet:hover {
  background: rgba(0,0,0,0.1);
}

.wallet-content {
  padding: 20px;
  max-height: 500px;
  overflow-y: auto;
}

.wallet-section {
  margin-bottom: 24px;
}

.wallet-section:last-child {
  margin-bottom: 0;
}

.wallet-section h4 {
  margin: 0 0 12px 0;
  color: var(--text, #fff);
  font-size: 14px;
  font-weight: 600;
}

.balance-grid {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.balance-card {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: var(--bg3, #2a2a2a);
  border: 1px solid var(--border, #333);
  border-radius: 8px;
  transition: all .2s;
}

.balance-card:hover {
  border-color: #FFD700;
  box-shadow: 0 2px 8px rgba(255,215,0,0.1);
}

.balance-icon {
  font-size: 24px;
  margin-right: 12px;
}

.balance-info {
  flex: 1;
}

.balance-label {
  font-size: 12px;
  color: var(--muted, #999);
  margin-bottom: 4px;
}

.balance-amount {
  font-size: 16px;
  font-weight: 700;
  color: var(--text, #fff);
  font-family: 'Courier New', monospace;
}

.balance-action {
  padding: 6px 12px;
  background: #FFD700;
  color: #000;
  border: none;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all .2s;
}

.balance-action:hover {
  background: #FFED4A;
  transform: translateY(-1px);
}

.quick-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.quick-action-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 8px;
  background: var(--bg3, #2a2a2a);
  border: 1px solid var(--border, #333);
  border-radius: 8px;
  cursor: pointer;
  transition: all .2s;
  text-decoration: none;
  color: var(--text, #fff);
}

.quick-action-btn:hover {
  border-color: #FFD700;
  background: var(--bg, #111);
  transform: translateY(-2px);
}

.action-icon {
  font-size: 20px;
  margin-bottom: 4px;
}

.quick-action-btn span:last-child {
  font-size: 11px;
  font-weight: 600;
}

.portfolio-summary {
  background: var(--bg3, #2a2a2a);
  border: 1px solid var(--border, #333);
  border-radius: 8px;
  padding: 12px 16px;
}

.portfolio-stat {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.portfolio-stat:last-child {
  margin-bottom: 0;
}

.stat-label {
  font-size: 12px;
  color: var(--muted, #999);
}

.stat-value {
  font-size: 13px;
  font-weight: 700;
  color: var(--text, #fff);
  font-family: 'Courier New', monospace;
}

.pnl-positive {
  color: #00c853;
}

.pnl-negative {
  color: #ff1744;
}
</style>

<!-- Bug-Proof Foundation -->
<script src="bug-proof-core.js"></script>
<!-- Credits System -->  
<script src="credits-system.js"></script>

<script>
// WALLET POPUP FUNCTIONS
function toggleWalletPopup() {
  const popup = document.getElementById('wallet-popup');
  const btn = document.getElementById('wallet-float-btn');
  
  if (popup) {
    popup.classList.toggle('hidden');
    btn.classList.toggle('wallet-active');
    
    // Update balances when opening
    if (!popup.classList.contains('hidden')) {
      updateWalletBalances();
    }
  }
}

function updateWalletBalances() {
  // Update INCENTIVES
  const incentivesAmount = document.getElementById('incentives-amount');
  const walletIncentives = document.getElementById('wallet-incentives');
  if (incentivesAmount && walletIncentives) {
    walletIncentives.textContent = incentivesAmount.textContent;
  }
  
  // Update Credits
  const creditsAmount = document.getElementById('credits-amount');
  const walletCredits = document.getElementById('wallet-credits');
  if (creditsAmount && walletCredits) {
    walletCredits.textContent = creditsAmount.textContent;
  }
  
  // Update USD Balance
  const usdBalance = document.getElementById('usd-balance');
  const walletUsd = document.getElementById('wallet-usd');
  if (usdBalance && walletUsd) {
    walletUsd.textContent = usdBalance.textContent;
  }
  
  // Update Crypto Balance
  const cryptoBalance = document.getElementById('crypto-balance');
  const walletCrypto = document.getElementById('wallet-crypto');
  const cryptoLabel = document.getElementById('crypto-balance-label');
  const walletCryptoLabel = document.getElementById('wallet-crypto-label');
  
  if (cryptoBalance && walletCrypto) {
    walletCrypto.textContent = cryptoBalance.textContent;
  }
  if (cryptoLabel && walletCryptoLabel) {
    walletCryptoLabel.textContent = cryptoLabel.textContent;
  }
}

// Quick action functions
function openConversionFromWallet() {
  if (window.creditsSystem) {
    window.creditsSystem.openConversionModal();
    toggleWalletPopup();
  } else {
    alert('üí∞ INCENTIVES ‚Üí Credits Conversion\n\n10,000 INCENTIVES available!\nConversion rate: 1 INCENTIVES = 10 Credits');
  }
}

function openCreditsManagement() {
  if (window.creditsSystem) {
    window.creditsSystem.openCreditsMenu();
    toggleWalletPopup();
  } else {
    alert('üí≥ Credits Management\n\nCurrent balance: 0 Credits\nServices available:\n‚Ä¢ Messages (1 credit)\n‚Ä¢ API calls (5 credits)\n‚Ä¢ AI analysis (10 credits)');
  }
}

function showTradingTab() {
  toggleWalletPopup();
  alert('üìä Switching to Trading Tab');
}

function connectWalletFromPopup() {
  const connectBtn = document.getElementById('connect-wallet');
  if (connectBtn) {
    connectBtn.click();
  }
  alert('üîó Connecting external crypto wallet...');
}

function showTransactionHistory() {
  alert('üìú Transaction History\n\nNo transactions yet.\nStart by converting INCENTIVES to Credits!');
  toggleWalletPopup();
}

function showServicePrices() {
  alert('üí∞ Service Prices\n\n‚Ä¢ Message: 1 Credit\n‚Ä¢ API Call: 5 Credits\n‚Ä¢ AI Analysis: 10 Credits\n‚Ä¢ Agent Deployment: 100 Credits\n‚Ä¢ Agent Rental: 50 Credits/day');
  toggleWalletPopup();
}

function playStation(station) {
  alert('üìª Playing: ' + station);
}

// Simple game functions
function toggleSettings() {
  document.getElementById('settings-modal').classList.toggle('hidden');
}

function toggleRadioPopup() {
  const popup = document.getElementById('radio-popup');
  const btn = document.getElementById('radio-float-btn');
  
  popup.classList.toggle('hidden');
  btn.classList.toggle('radio-active');
}

function showTab(tab) {
  console.log('Switching to tab:', tab);
}

function changeTradingPair() {
  console.log('Trading pair changed');
}

// Simple balance fix
localStorage.setItem('incentives_balance_default', '10000');

console.log('üéÆ Game loaded with wallet popup above radio button!');
</script>

</body>
</html>
